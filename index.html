<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AI Event Logger - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f0f2f5; font-family: sans-serif; display: flex; justify-content: center; padding: 40px; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        .box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; margin-top: 10px; }
        #reviewDisplay { font-style: italic; color: #555; margin: 15px 0; min-height: 40px; }
        .status { text-align: center; font-size: 14px; margin-top: 15px; color: #666; }
        .POSITIVE { color: #28a745; font-weight: bold; }
        .NEGATIVE { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h3>MVP Event Logger</h3>
    
    <div class="box">
        <label>Settings</label>
        <input type="text" id="gasUrl" placeholder="Google Script URL (/exec)">
        <input type="password" id="hfToken" placeholder="Hugging Face Token (hf_...)">
        <button class="btn-blue" onclick="saveSettings()">Save to LocalStorage</button>
    </div>

    <div class="box">
        <div id="reviewDisplay">Review will appear here...</div>
        <button class="btn-green" id="runBtn" onclick="analyzeAndLog()">Analyze Random Review</button>
    </div>

    <div id="status" class="status"></div>
</div>

<script>
    // –ú–∞—Å—Å–∏–≤ –æ—Ç–∑—ã–≤–æ–≤ (Randomly selected –ø–æ –¢–ó)
    const reviews = [
        "The interface is very intuitive and easy to use!",
        "Awful experience. The app crashes every time I open it.",
        "Average product. It works, but the design is outdated.",
        "Love this! Saved me so much time. Highly recommended.",
        "Total waste of time. Doesn't do what it promises."
    ];

    // –ü—É–Ω–∫—Ç –¢–ó: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
    window.onload = () => {
        document.getElementById('gasUrl').value = localStorage.getItem('gasUrl') || '';
        document.getElementById('hfToken').value = localStorage.getItem('hfToken') || '';
        
        // –ü—É–Ω–∫—Ç –¢–ó: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ User ID
        if (!localStorage.getItem('myUserId')) {
            localStorage.setItem('myUserId', 'user_' + Math.random().toString(36).substr(2, 9));
        }
    };

    function saveSettings() {
        localStorage.setItem('gasUrl', document.getElementById('gasUrl').value);
        localStorage.setItem('hfToken', document.getElementById('hfToken').value);
        showStatus("‚úÖ Settings saved!");
    }

    function showStatus(text) {
        document.getElementById('status').innerText = text;
    }

    async function analyzeAndLog() {
        const gasUrl = document.getElementById('gasUrl').value;
        const hfToken = document.getElementById('hfToken').value;
        const btn = document.getElementById('runBtn');

        if (!gasUrl || !hfToken) return alert("Fill in the settings first!");

        btn.disabled = true;
        showStatus("ü§ñ AI is thinking...");

        // 1. –í—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞
        const randomReview = reviews[Math.floor(Math.random() * reviews.length)];
        document.getElementById('reviewDisplay').innerText = `"${randomReview}"`;

        try {
            // 2. –†–µ–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Hugging Face (–∫–∞–∫ –≤ –¥–µ–º–æ)
            const hfRes = await fetch("https://api-inference.huggingface.co/models/distilbert-base-uncased-finetuned-sst-2-english", {
                headers: { Authorization: `Bearer ${hfToken}` },
                method: "POST",
                body: JSON.stringify({ inputs: randomReview }),
            });
            const hfData = await hfRes.json();
            const res = hfData[0][0];
            const sentimentStr = `${res.label} (${(res.score * 100).toFixed(1)}%)`;

            // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google Sheets (Simple Request)
            // –ü—É–Ω–∫—Ç –¢–ó: x-www-form-urlencoded –∏ –Ω–∏–∫–∞–∫–∏—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
            const formData = new URLSearchParams();
            formData.append('ts_iso', new Date().toISOString()); // –ö–æ–ª–æ–Ω–∫–∞ 1
            formData.append('review', randomReview);            // –ö–æ–ª–æ–Ω–∫–∞ 2
            formData.append('sentiment', sentimentStr);        // –ö–æ–ª–æ–Ω–∫–∞ 3
            formData.append('meta', JSON.stringify({           // –ö–æ–ª–æ–Ω–∫–∞ 4
                userId: localStorage.getItem('myUserId'),
                ua: navigator.userAgent,
                lang: navigator.language
            }));

            await fetch(gasUrl, {
                method: 'POST',
                mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è –¢–ó!
                body: formData
            });

            showStatus(`‚úÖ Logged: ${sentimentStr}`);
        } catch (err) {
            showStatus("‚ùå Error! Check token or console.");
            console.error(err);
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
