<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Event Logger - Final Fixed</title>
    <style>
        body { background: #f4f7f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 450px; }
        h2 { color: #333; margin-top: 0; text-align: center; }
        .section { border: 1px solid #e1e4e8; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; }
        label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-save { background: #6e7781; color: white; margin-bottom: 10px; }
        .btn-main { background: #2da44e; color: white; font-size: 16px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; }
        #reviewText { font-style: italic; color: #444; margin: 20px 0; min-height: 44px; text-align: center; border-left: 3px solid #2da44e; padding-left: 10px; }
        .status { text-align: center; font-size: 14px; margin-top: 15px; min-height: 20px; }
        .error { color: #cf222e; }
        .success { color: #2da44e; }
    </style>
</head>
<body>

<div class="card">
    <h2>MVP Event Logger</h2>
    
    <div class="section">
        <label>GOOGLE SCRIPT URL</label>
        <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
        <label>HUGGING FACE TOKEN</label>
        <input type="password" id="hfToken" placeholder="hf_...">
        <button class="btn-save" onclick="saveSettings()">Save Settings</button>
    </div>

    <div class="section">
        <div id="reviewText">Press the button to start...</div>
        <button class="btn-main" id="runBtn" onclick="analyzeAndLog()">Analyze & Log to Sheet</button>
        <div id="status" class="status"></div>
    </div>
</div>

<script>
    const reviews = [
        "The interface is very intuitive and easy to use!",
        "Awful experience. The app crashes every time I open it.",
        "Average product. It works, but the design is outdated.",
        "Love this! Saved me so much time. Highly recommended.",
        "Total waste of time. Doesn't do what it promises."
    ];

    window.onload = () => {
        document.getElementById('gasUrl').value = localStorage.getItem('gasUrl') || '';
        document.getElementById('hfToken').value = localStorage.getItem('hfToken') || '';
        if (!localStorage.getItem('myUserId')) {
            localStorage.setItem('myUserId', 'user_' + Math.random().toString(36).substr(2, 9));
        }
    };

    function saveSettings() {
        localStorage.setItem('gasUrl', document.getElementById('gasUrl').value.trim());
        localStorage.setItem('hfToken', document.getElementById('hfToken').value.trim());
        document.getElementById('status').innerHTML = "<span class='success'>‚úÖ Saved to LocalStorage!</span>";
    }

    async function analyzeAndLog() {
        const gasUrl = document.getElementById('gasUrl').value.trim();
        const hfToken = document.getElementById('hfToken').value.trim();
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('status');

        if (!gasUrl || !hfToken) {
            alert("Please fill in both URL and Token!");
            return;
        }

        btn.disabled = true;
        status.innerText = "ü§ñ AI is analyzing...";
        
        const randomReview = reviews[Math.floor(Math.random() * reviews.length)];
        document.getElementById('reviewText').innerText = `"${randomReview}"`;

        let sentimentResult = "Error (AI blocked)";

        try {
            // –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º URL-–ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —Ç–æ–∫–µ–Ω–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å CORS Preflight –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
            const apiUrl = "https://api-inference.huggingface.co/models/distilbert-base-uncased-finetuned-sst-2-english";
            
            const hfRes = await fetch(apiUrl, {
                headers: { 
                    "Authorization": `Bearer ${hfToken}`,
                    "Content-Type": "application/json"
                },
                method: "POST",
                body: JSON.stringify({ inputs: randomReview }),
            });

            const hfData = await hfRes.json();

            if (hfRes.ok && Array.isArray(hfData)) {
                const res = hfData[0][0];
                sentimentResult = `${res.label} (${(res.score * 100).toFixed(1)}%)`;
            } else if (hfData.error && hfData.error.includes("currently loading")) {
                // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –≥—Ä—É–∑–∏—Ç—Å—è, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç—É—Å
                sentimentResult = "Model Loading... Click again";
            } else {
                sentimentResult = "AI Unavailable";
            }
        } catch (err) {
            console.error("AI Error:", err);
            sentimentResult = "CORS/Network Error";
        }

        // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ –≤ —Ç–∞–±–ª–∏—Ü—É
        status.innerText = "Sending log to Google Sheets...";
        
        const formData = new URLSearchParams();
        formData.append('ts_iso', new Date().toISOString());
        formData.append('review', randomReview);
        formData.append('sentiment', sentimentResult);
        formData.append('meta', JSON.stringify({
            userId: localStorage.getItem('myUserId'),
            ua: navigator.userAgent
        }));

        try {
            await fetch(gasUrl, {
                method: 'POST',
                mode: 'no-cors', // –û—Å—Ç–∞–≤–ª—è–µ–º no-cors –¥–ª—è Google Sheets –ø–æ –¢–ó
                body: formData
            });
            status.innerHTML = `<span class='success'>‚úÖ Logged: ${sentimentResult}</span>`;
        } catch (err) {
            status.innerHTML = "<span class='error'>‚ùå Failed to reach Google Script</span>";
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
